#! /bin/sh

secretname=$(kubectl get secret -n {{ ns_name }} | grep {{ sa_name }} | awk '{print $1}')

token=$(kubectl describe secret $secretname -n {{ ns_name }} | grep token: | awk '{print $2}')

cat <<EOF > {{ file_dest }}/kubeconfig
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR2akNDQXFhZ0F3SUJBZ0lVVEdpR3BXdmNYSWZHd2RZdmlzODd0cEVyL3JRd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1pURUxNQWtHQTFVRUJoTUNRMDR4RWpBUUJnTlZCQWdUQ1VkMVlXNW5SRzl1WnpFUk1BOEdBMVVFQnhNSQpVMmhsYmxwb1pXNHhDekFKQmdOVkJBb1RBbE5HTVEwd0N3WURWUVFMRXdSelptRnBNUk13RVFZRFZRUURFd3ByCmRXSmxjbTVsZEdWek1CNFhEVEU0TURNeU56QTVNRFV3TUZvWERUSXpNRE15TmpBNU1EVXdNRm93WlRFTE1Ba0cKQTFVRUJoTUNRMDR4RWpBUUJnTlZCQWdUQ1VkMVlXNW5SRzl1WnpFUk1BOEdBMVVFQnhNSVUyaGxibHBvWlc0eApDekFKQmdOVkJBb1RBbE5HTVEwd0N3WURWUVFMRXdSelptRnBNUk13RVFZRFZRUURFd3ByZFdKbGNtNWxkR1Z6Ck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBclgvZ2lLbFRpVVArRmc0eG9wc28KRWpXNU8ra2kyRVFXTlJmc0Y2WjdHOXZaU0d2SkRBMHpXVWdpejl1MDdBV3RDMWhUakZ4c1ZGblVSYlFkRzdteApEMHBqb3RtU0pkMnRSQm9abWJMTXJDTHdDaDJSTzhxUzZXYktQRHFibk5xTWp0TThNSjVaZGordHhUbzM4cWhKCk9VUHMycWc5M1BSOXVWTWxPbk50UFhWa3haTndiazhLNVVWaE1hRmN3VVhnOGk5dDUxUnRIRmdqTllYb1ZiajAKSmJSUndFbVFleC81T1UwS3VJQVcyZ2RKR2kvNEZxUkx6ZzVNN0Zqa2RhdkRZVzhGT04xLzR3UEdBSG9QQ2lYWApkWTU1WkQ1VFFPbWV5Z0lhLzhkbGJPQS9MdFRQcndpWmhVSTk5UnhybVFReXVhRXBvZ2dEK3lDYldDWVNWVWVECm93SURBUUFCbzJZd1pEQU9CZ05WSFE4QkFmOEVCQU1DQVFZd0VnWURWUjBUQVFIL0JBZ3dCZ0VCL3dJQkFqQWQKQmdOVkhRNEVGZ1FVWEluRXdFemRMaisrZDNtemx2eG54NWVMV1RRd0h3WURWUjBqQkJnd0ZvQVVYSW5Fd0V6ZApMaisrZDNtemx2eG54NWVMV1RRd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFBUzRQaDRtMFFiMlpITWMyMldSCnFvb0g5eXI0eGFPbU5jdUhXTlRsL2REVEl6R1Z3aTVOQWFXRUVhN3h0REt0Wnk0TCtTOVF0Qml3RHUzMTJCOUYKaDB3MWtLTGZ5R0FHVllVWW5uTWV0ZUI2c2I1MW5XcEdJR3RXVFphaDBiWnhhYnBNQnlMR1RJL0RYVkNrY2NyOQpOOExZWElya0tGMHg2NWRGaDRLWEUrTjFmbDVBRHhib1p1UWhGK3BwM1JBbG1IU2Z0Y2FySDUvN1Radm1pQU1vCmd1di9qcjR2NEZTWkN4ZUJNNDZ2SzJjSDY5WjNwZFp5eTFqU1NSd1dieWdreDdWMjlnNEhjYlNER1ZTck1VQ3IKVm9PMUxCVjZmTjZHeFErV2NCczh3c2tJU3ZNbEptSkRZdjI3SGVJSWdKa2hMQTMyVXpITXhqTDRpNmMzTTB6Rwp3cmM9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://192.168.56.200:443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: {{ sa_name }}
    namespace: {{ ns_name }}
  name: {{ ns_name }}-admin@kubernetes
current-context: {{ ns_name }}-admin@kubernetes
kind: Config
preferences: {}
users:
- name: {{ sa_name }}
  user:
    token: $token
EOF
